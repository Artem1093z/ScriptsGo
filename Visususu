local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- // КОНФИГУРАЦИЯ //
local Purple = Color3.fromRGB(140, 0, 255)
local BrightPurple = Color3.fromRGB(220, 80, 255)
local PureWhite = Color3.new(1, 1, 1)
local GlobalColor = Purple

-- // 1. АТМОСФЕРА //
RunService.RenderStepped:Connect(function()
    local alpha = (math.sin(tick() * 0.5) + 1) / 2
    GlobalColor = PureWhite:Lerp(Purple, alpha)
    
    Lighting.FogColor = GlobalColor
    Lighting.FogEnd = 600
    Lighting.Ambient = GlobalColor
    Lighting.ClockTime = 0 
end)

-- // 2. TARGET HUD (TRIGGER GUI) //
local TargetHUD = nil
local TargetName = nil
local TargetHealthBar = nil
local TargetHealthText = nil
local TargetImage = nil
local CurrentTarget = nil

local function CreateTargetHUD()
    if CoreGui:FindFirstChild("CMoonTargetHUD") then CoreGui.CMoonTargetHUD:Destroy() end

    local screengui = Instance.new("ScreenGui")
    screengui.Name = "CMoonTargetHUD"
    screengui.Parent = CoreGui
    screengui.IgnoreGuiInset = true

    -- Основной контейнер
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "Main"
    mainFrame.Size = UDim2.new(0, 260, 0, 80)
    -- Позиция: Чуть правее центра снизу (стиль майнкрафта)
    mainFrame.Position = UDim2.new(0.55, 0, 0.75, 0) 
    mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    mainFrame.BackgroundTransparency = 0.2
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screengui
    mainFrame.Visible = false -- Скрыт по умолчанию

    -- Скругление
    local uiCorner = Instance.new("UICorner", mainFrame)
    uiCorner.CornerRadius = UDim.new(0, 10)

    -- Обводка
    local uiStroke = Instance.new("UIStroke", mainFrame)
    uiStroke.Color = Purple
    uiStroke.Thickness = 2
    uiStroke.Transparency = 0

    -- Аватарка
    local avatarFrame = Instance.new("ImageLabel", mainFrame)
    avatarFrame.Size = UDim2.new(0, 60, 0, 60)
    avatarFrame.Position = UDim2.new(0, 10, 0.5, -30)
    avatarFrame.BackgroundColor3 = Color3.new(0,0,0)
    avatarFrame.BackgroundTransparency = 0.5
    
    local avCorner = Instance.new("UICorner", avatarFrame)
    avCorner.CornerRadius = UDim.new(0, 8)
    
    TargetImage = avatarFrame

    -- Имя
    TargetName = Instance.new("TextLabel", mainFrame)
    TargetName.Size = UDim2.new(0, 150, 0, 20)
    TargetName.Position = UDim2.new(0, 80, 0, 15)
    TargetName.BackgroundTransparency = 1
    TargetName.Text = "Username"
    TargetName.Font = Enum.Font.GothamBold
    TargetName.TextColor3 = PureWhite
    TargetName.TextSize = 18
    TargetName.TextXAlignment = Enum.TextXAlignment.Left

    -- Фон бара здоровья
    local barBg = Instance.new("Frame", mainFrame)
    barBg.Size = UDim2.new(0, 160, 0, 10)
    barBg.Position = UDim2.new(0, 80, 0, 45)
    barBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    barBg.BorderSizePixel = 0
    
    local barCorner = Instance.new("UICorner", barBg)
    barCorner.CornerRadius = UDim.new(1, 0)

    -- Сам бар здоровья
    TargetHealthBar = Instance.new("Frame", barBg)
    TargetHealthBar.Size = UDim2.new(1, 0, 1, 0)
    TargetHealthBar.BackgroundColor3 = PureWhite
    TargetHealthBar.BorderSizePixel = 0
    
    local fillCorner = Instance.new("UICorner", TargetHealthBar)
    fillCorner.CornerRadius = UDim.new(1, 0)
    
    -- Градиент для бара
    local gradient = Instance.new("UIGradient", TargetHealthBar)
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Purple),
        ColorSequenceKeypoint.new(1, PureWhite)
    }

    -- Текст здоровья (HP)
    TargetHealthText = Instance.new("TextLabel", mainFrame)
    TargetHealthText.Size = UDim2.new(0, 160, 0, 20)
    TargetHealthText.Position = UDim2.new(0, 80, 0, 40) -- Поверх бара
    TargetHealthText.BackgroundTransparency = 1
    TargetHealthText.Text = "100 HP"
    TargetHealthText.Font = Enum.Font.Code
    TargetHealthText.TextColor3 = PureWhite
    TargetHealthText.TextSize = 12
    TargetHealthText.TextStrokeTransparency = 0.5
    TargetHealthText.ZIndex = 2
    
    TargetHUD = mainFrame
end

local function GetClosestPlayer()
    local closest = nil
    local minDist = 100 -- Дистанция срабатывания (Trigger Distance)
    
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return nil end
    local myPos = LocalPlayer.Character.HumanoidRootPart.Position

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChild("Humanoid") then
            local hum = plr.Character.Humanoid
            if hum.Health > 0 then
                local dist = (plr.Character.HumanoidRootPart.Position - myPos).Magnitude
                if dist < minDist then
                    minDist = dist
                    closest = plr
                end
            end
        end
    end
    return closest
end

local function UpdateHUD()
    RunService.RenderStepped:Connect(function()
        if not TargetHUD then return end
        
        local target = GetClosestPlayer()
        
        if target then
            -- Если цель сменилась или появилась
            if CurrentTarget ~= target then
                CurrentTarget = target
                TargetName.Text = target.Name
                -- Загрузка аватарки
                task.spawn(function()
                    local content = Players:GetUserThumbnailAsync(target.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
                    TargetImage.Image = content
                end)
                
                -- Анимация появления
                TargetHUD.Visible = true
                TweenService:Create(TargetHUD, TweenInfo.new(0.3), {BackgroundTransparency = 0.2}):Play()
            end
            
            -- Обновление HP
            local hum = target.Character and target.Character:FindFirstChild("Humanoid")
            if hum then
                local hp = hum.Health
                local maxHp = hum.MaxHealth
                local pct = math.clamp(hp / maxHp, 0, 1)
                
                -- Плавный бар
                TweenService:Create(TargetHealthBar, TweenInfo.new(0.2), {Size = UDim2.new(pct, 0, 1, 0)}):Play()
                TargetHealthText.Text = math.floor(hp) .. " / " .. math.floor(maxHp)
            end
        else
            -- Если цели нет
            if CurrentTarget ~= nil then
                CurrentTarget = nil
                TargetHUD.Visible = false
            end
        end
    end)
end

-- // 3. ПРИЦЕЛ //
local function AddCrosshair()
    if CoreGui:FindFirstChild("CMoonCrosshair") then CoreGui.CMoonCrosshair:Destroy() end
    local gui = Instance.new("ScreenGui", CoreGui); gui.Name="CMoonCrosshair"; gui.IgnoreGuiInset=true
    local l = Instance.new("TextLabel", gui); l.Text="+"; l.BackgroundTransparency=1; l.Size=UDim2.new(0,50,0,50); l.Position=UDim2.new(0.5,0,0.5,-2); l.AnchorPoint=Vector2.new(0.5,0.5)
    l.TextColor3=PureWhite; l.TextStrokeColor3=Color3.new(0,0,0); l.TextStrokeTransparency=0; l.Font=Enum.Font.SourceSans; l.TextSize=24
end

-- // 4. ВЗРЫВНОЙ ПРЫЖОК //
local function JumpFX(pos)
    spawn(function()
        local r = Instance.new("Part", workspace); r.Anchored=true; r.CanCollide=false; r.Material=Enum.Material.Neon; r.Shape=Enum.PartType.Cylinder; r.Color=Purple; r.CFrame=CFrame.new(pos)*CFrame.Angles(0,0,math.rad(90)); r.Size=Vector3.new(0.1,3,3)
        TweenService:Create(r, TweenInfo.new(0.6, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size=Vector3.new(0.1,40,40), Transparency=1}):Play()
        
        local s = Instance.new("Part", workspace); s.Anchored=true; s.CanCollide=false; s.Material=Enum.Material.Neon; s.Shape=Enum.PartType.Cylinder; s.Color=PureWhite; s.CFrame=CFrame.new(pos)*CFrame.Angles(0,0,math.rad(90)); s.Size=Vector3.new(0.1,2,2)
        TweenService:Create(s, TweenInfo.new(0.4, Enum.EasingStyle.Exponential, Enum.EasingDirection.Out), {Size=Vector3.new(0.1,28,28), Transparency=1}):Play()

        local lPart = Instance.new("Part", workspace); lPart.Anchored=true; lPart.Transparency=1; lPart.CanCollide=false; lPart.Position=pos
        local l = Instance.new("PointLight", lPart); l.Color=BrightPurple; l.Range=40; l.Brightness=5
        TweenService:Create(l, TweenInfo.new(0.5), {Brightness=0, Range=0}):Play()

        local p = Instance.new("ParticleEmitter", lPart); p.Texture="rbxassetid://14629728430"
        p.Color=ColorSequence.new({ColorSequenceKeypoint.new(0,PureWhite), ColorSequenceKeypoint.new(0.3,BrightPurple), ColorSequenceKeypoint.new(1,Purple)})
        p.Size=NumberSequence.new({NumberSequenceKeypoint.new(0,4), NumberSequenceKeypoint.new(1,0)}); p.Lifetime=NumberRange.new(0.5,1); p.Speed=NumberRange.new(40,70)
        p.SpreadAngle=Vector2.new(360,360); p.Drag=3; p.Rotation=NumberRange.new(0,360); p.RotSpeed=NumberRange.new(-360,360); p.LightEmission=1; p.Rate=0
        p:Emit(500) 
        task.wait(1.5); r:Destroy(); s:Destroy(); lPart:Destroy()
    end)
end

-- // 5. ТРЕЙСЕРЫ //
local function UpdateTracers()
    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end
    local myAtt = myRoot:FindFirstChild("TracerAtt")
    if not myAtt then myAtt = Instance.new("Attachment", myRoot); myAtt.Name = "TracerAtt" end
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and v.Character then
            local beam = v.Character:FindFirstChild("MC_Tracer")
            if beam then beam.Attachment0 = myAtt end
        end
    end
end

local function AddTracer(char)
    if char == LocalPlayer.Character then return end
    local root = char:WaitForChild("HumanoidRootPart", 10)
    if not root then return end
    local enemyAtt = Instance.new("Attachment", root)
    local beam = Instance.new("Beam", char); beam.Name="MC_Tracer"; beam.Attachment1=enemyAtt; beam.FaceCamera=true; beam.Width0=0.1; beam.Width1=0.1
    beam.Color=ColorSequence.new(PureWhite, Purple); beam.Transparency=NumberSequence.new(0.2, 0.5)
    UpdateTracers()
end

-- // 6. ВИЗУАЛЫ ВРАГОВ //
local function AddNametag(model, player)
    if model:FindFirstChild("MC_Tag") then return end
    local head = model:WaitForChild("Head", 10)
    if not head then return end
    local bb = Instance.new("BillboardGui", model); bb.Name="MC_Tag"; bb.Adornee=head; bb.Size=UDim2.new(0,200,0,50); bb.StudsOffset=Vector3.new(0,4,0); bb.AlwaysOnTop=true
    local t = Instance.new("TextLabel", bb); t.Size=UDim2.new(1,0,1,0); t.BackgroundTransparency=1; t.Font=Enum.Font.Code; t.TextSize=16; t.TextColor3=PureWhite; t.TextStrokeTransparency=0
    task.spawn(function()
        local hum = model:WaitForChild("Humanoid", 10)
        while model.Parent and hum do
            local hp = math.floor(hum.Health)
            t.Text = string.format("%s [%d]", player.Name, hp)
            t.TextColor3 = hp > 50 and PureWhite or Color3.fromRGB(255, 50, 50)
            task.wait(0.1)
        end
    end)
end

local function AddSelectionBox(model)
    if model:FindFirstChild("MC_Box") then return end
    local b = Instance.new("SelectionBox", model); b.Name="MC_Box"; b.Adornee=model; b.LineThickness=0.05; b.Color3=BrightPurple; b.SurfaceColor3=Purple; b.SurfaceTransparency=0.8; b.Transparency=0.3
end

local function AddSpinningCross(model)
    if model:FindFirstChild("SpinningCrossUI") then return end
    local root = model:WaitForChild("HumanoidRootPart", 10)
    if not root then return end
    local bb = Instance.new("BillboardGui", model); bb.Name="SpinningCrossUI"; bb.Adornee=root; bb.Size=UDim2.new(2.5,0,2.5,0); bb.StudsOffset=Vector3.new(0,2,0); bb.AlwaysOnTop=true
    local c = Instance.new("Frame", bb); c.Size=UDim2.new(1,0,1,0); c.BackgroundTransparency=1; c.AnchorPoint=Vector2.new(0.5,0.5); c.Position=UDim2.new(0.5,0,0.5,0)
    local s = Instance.new("UIStroke", c); s.Thickness=1.5; s.Color=PureWhite
    local v = Instance.new("Frame", c); v.BackgroundColor3=BrightPurple; v.Size=UDim2.new(0.15,0,1,0); v.Position=UDim2.new(0.425,0,0,0); v.BorderSizePixel=0
    local h = Instance.new("Frame", c); h.BackgroundColor3=BrightPurple; h.Size=UDim2.new(1,0,0.15,0); h.Position=UDim2.new(0,0,0.425,0); h.BorderSizePixel=0
    TweenService:Create(c, TweenInfo.new(4, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, -1), {Rotation=360}):Play()
end

local function StartBacktrack(char)
    if char == LocalPlayer.Character then return end
    local root = char:WaitForChild("HumanoidRootPart", 10)
    if not root then return end
    task.spawn(function()
        local lastPos = root.Position
        while char.Parent and root.Parent do
            if (root.Position - lastPos).Magnitude > 0.5 then
                local g = Instance.new("Part", workspace); g.Size=root.Size; g.CFrame=root.CFrame; g.Anchored=true; g.CanCollide=false; g.Material=Enum.Material.Neon; g.Color=Purple; g.Transparency=0.6
                TweenService:Create(g, TweenInfo.new(1), {Transparency=1}):Play(); Debris:AddItem(g, 1); lastPos = root.Position
            end
            task.wait(0.1)
        end
    end)
end

-- // 7. ЛОКАЛЬНЫЙ ИГРОК //
local function SetupLocal(char)
    AddCrosshair()

    -- Шляпа
    local head = char:WaitForChild("Head", 10)
    if head then
        local hat = Instance.new("Part", workspace); hat.Name="ChinaHat"; hat.Size=Vector3.new(1,1,1); hat.CanCollide=false; hat.Anchored=true; hat.Transparency=0.3; hat.Material=Enum.Material.Neon
        local m = Instance.new("SpecialMesh", hat); m.MeshType=Enum.MeshType.FileMesh; m.MeshId="rbxassetid://1033714"; m.Scale=Vector3.new(2.2,1.1,2.2)
        local b = Instance.new("SelectionBox", hat); b.Adornee=hat; b.LineThickness=0.05; b.Color3=PureWhite; b.Transparency=0
        RunService.RenderStepped:Connect(function()
            if not char.Parent then hat:Destroy() return end
            hat.Color = GlobalColor; hat.CFrame = head.CFrame * CFrame.new(0,1.1,0) * CFrame.Angles(0, tick()*2, 0)
        end)
    end

    -- Плащ
    local torso = char:WaitForChild("UpperTorso", 5) or char:WaitForChild("Torso", 5)
    local root = char:WaitForChild("HumanoidRootPart", 5)
    if torso and root then
        local cape = Instance.new("Part", char); cape.Name="Cape"; cape.Size=Vector3.new(1.8,3.5,0.1); cape.Material=Enum.Material.Neon; cape.CanCollide=false; cape.Massless=true
        local b = Instance.new("SelectionBox", cape); b.Adornee=cape; b.Color3=PureWhite; b.LineThickness=0.05
        local mot = Instance.new("Motor6D", cape); mot.Part0=torso; mot.Part1=cape; mot.C0=CFrame.new(0,0.8,0.5); mot.C1=CFrame.new(0,1.75,0)
        task.spawn(function()
            while cape.Parent and char.Parent do
                cape.Color = GlobalColor
                local vel = root.Velocity; local spd = vel.Magnitude; local ang = 0
                if spd > 0.1 then ang = math.clamp(spd/15, 0, 0.8) end
                if vel.Y > 0 then ang = ang + 0.5 elseif vel.Y < 0 then ang = ang + 0.8 end
                mot.C0 = mot.C0:Lerp(CFrame.new(0,0.8,0.5)*CFrame.Angles(math.rad(-ang*45),0,0), 0.1)
                task.wait(0.016)
            end
        end)
    end

    -- Трейл
    local tAtt1, tAtt2 = Instance.new("Attachment", root), Instance.new("Attachment", root)
    tAtt1.Position=Vector3.new(0,-1.5,0); tAtt2.Position=Vector3.new(0,1.5,0)
    local t = Instance.new("Trail", char); t.Attachment0=tAtt1; t.Attachment1=tAtt2; t.Color=ColorSequence.new(PureWhite, Purple); t.Transparency=NumberSequence.new(0.2,1); t.Lifetime=0.5
    
    local hum = char:WaitForChild("Humanoid", 10)
    if hum then
        hum.StateChanged:Connect(function(o, n)
            if n == Enum.HumanoidStateType.Jumping then JumpFX(root.Position - Vector3.new(0,2.5,0)) end
        end)
    end
    UpdateTracers()
end

local function SetupEnemy(char, plr)
    task.spawn(function()
        local root = char:WaitForChild("HumanoidRootPart", 10)
        if not root then return end
        AddSelectionBox(char)
        AddNametag(char, plr)
        AddTracer(char)
        AddSpinningCross(char)
        StartBacktrack(char)
    end)
end

-- ИНИЦИАЛИЗАЦИЯ GUI
CreateTargetHUD()
UpdateHUD()

for _, v in pairs(Players:GetPlayers()) do
    if v ~= LocalPlayer and v.Character then SetupEnemy(v.Character, v) end
    v.CharacterAdded:Connect(function(c) if v ~= LocalPlayer then SetupEnemy(c, v) end end)
end
Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function(c) if p ~= LocalPlayer then SetupEnemy(c, p) end end)
end)

if LocalPlayer.Character then SetupLocal(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(SetupLocal)

game:GetService("StarterGui"):SetCore("SendNotification", {Title="C-Moon Client", Text="Target HUD Loaded", Duration=3})
